!function(e,t){"use strict";var n=e.SEENTICS_CORE;if(n){var r={activeFunnels:[],currentFunnels:new Map,initialized:!1,buffer:[]},s=function(){var e={};r.currentFunnels.forEach(function(t,n){e[n]=t}),sessionStorage.setItem("seentics_funnel_progress",JSON.stringify(e))},i=function(e){return void 0!==e.order?e.order:e.step_order||0},c=function(t,n){var r=(t.stepType||t.step_type||"").toLowerCase();if("page_view"===r||"pageview"===r){var s=e.location.pathname,i=t.pagePath||t.page_path;switch(t.matchType||t.match_type||"exact"){case"contains":return s.includes(i);case"starts_with":case"startswith":return s.startsWith(i);case"regex":try{return new RegExp(i).test(s)}catch(e){return!1}default:return s===i}}return"event"===r&&n.eventName===(t.eventType||t.event_type)},o=function(e,t){r.buffer.push(Object.assign({funnel_id:e,website_id:n.config.websiteId,visitor_id:n.state.visitorId,session_id:n.state.sessionId,started_at:(r.currentFunnels.get(e)||{}).startedAt||(new Date).toISOString(),timestamp:(new Date).toISOString()},t))},u=function(e,t){t=t||{},r.activeFunnels.forEach(function(e){var u=e.id,a=e.steps||[];if(0!==a.length){var f=i(a[0]),l=i(a[a.length-1]),d=r.currentFunnels.get(u);if(d){for(var p=null,v=0;v<a.length;v++)if(i(a[v])>d.currentStep){p=a[v];break}if(p&&c(p,t)){var g=i(p);d.currentStep=g,d.completedSteps.push(g),s();var _=g===l;o(u,{event_type:_?"conversion":"progress",step_name:p.name,current_step:g,completed_steps:d.completedSteps,converted:_}),_?(n.emit("funnel:completed",{funnelId:u,steps:d.completedSteps}),r.currentFunnels.delete(u),s()):n.emit("funnel:progress",{funnelId:u,step:p,progress:d})}}else c(a[0],t)&&(d={currentStep:f,completedSteps:[f],startedAt:(new Date).toISOString()},r.currentFunnels.set(u,d),s(),o(u,{event_type:"start",step_name:a[0].name,current_step:f,completed_steps:[f]}),n.emit("funnel:started",{funnelId:u,step:a[0]}))}})};setInterval(function(){if(0!==r.buffer.length){var e=r.buffer.slice();r.buffer=[],n.api.send("funnels/batch",{website_id:n.config.websiteId,events:e}).catch(function(){r.buffer=e.concat(r.buffer)})}},3e4);var a=function(){0!==r.buffer.length&&(navigator.sendBeacon(n.config.apiHost+"/api/v1/funnels/batch",new Blob([JSON.stringify({website_id:n.config.websiteId,events:r.buffer})],{type:"application/json"})),r.buffer=[])},f=function(){n.on("analytics:pageview",function(e){u(0,e)}),n.on("analytics:event",function(e){u(0,e)}),e.addEventListener("beforeunload",function(){r.currentFunnels.forEach(function(e,t){var n=r.activeFunnels.find(function(e){return e.id===t});n&&e.currentStep<(n.steps||[]).length-1&&o(t,{event_type:"dropoff",current_step:e.currentStep,completed_steps:e.completedSteps})}),a()}),t.addEventListener("visibilitychange",function(){"hidden"===t.visibilityState&&a()})},l=function(){r.initialized||(r.initialized=!0,n.api.get("funnels/active",{website_id:n.config.websiteId}).then(function(e){r.activeFunnels=e.funnels||[],r.activeFunnels.forEach(function(e){e.steps&&e.steps.sort(function(e,t){return(void 0!==e.order?e.order:e.step_order||0)-(void 0!==t.order?t.order:t.step_order||0)})}),n.emit("funnel:loaded",{count:r.activeFunnels.length});var t=sessionStorage.getItem("seentics_funnel_progress");if(t){var s=JSON.parse(t);Object.entries(s).forEach(function(e){r.currentFunnels.set(e[0],e[1])})}}).catch(function(e){n.config.debug&&console.error("[Seentics Funnel] Load failed:",e)}).then(f))};n.isReady&&n.isReady()?l():n.on("core:ready",l),e.seentics=e.seentics||{},e.seentics.funnel={getProgress:function(e){return r.currentFunnels.get(e)},getAllProgress:function(){return Object.fromEntries(r.currentFunnels)},reset:function(e){e?r.currentFunnels.delete(e):r.currentFunnels.clear(),s()}}}else console.error("[Seentics Funnel] Core not loaded.")}(window,document);